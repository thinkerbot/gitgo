#!/bin/bash
############################################################################
usage="\
usage: gitgo-write [-a ATTACHMENT...] [-b BRANCH] [-f] [-h] [-m MODE] [-t TAG...] [THREAD...]

  Writes a message to the 'gitgo' branch to the specified threads. If the
  branch does not exist, it will be created.

  Attachments are saved in the tree and the message is read from stdin. The
  parent commits are determined from the threads; all tail messages are made
  parents by default. Specific shas can be used instead of thread ids. Starts
  a new thread if no threads are specified.

  Prints the sha of the resulting message.

options:

        -a    attachment files
        -b    the storage branch (default 'gitgo')
        -f    force write unresolvable threads
        -h    prints this help
        -m    linkage mode (add, update, delete)
        -p    preview only
        -t    specify tags

"
############################################################################

attachments=""
branch="gitgo"
force=""
mode="+"
preview=""
tags=""
while getopts "a:b:fhm:pt:" option
do
  case $option in
    a  )  attachments="${attachments}${OPTARG}\n" ;;
    b  )  branch="$OPTARG" ;;
    f  )  force="true" ;;
    h  )  printf "$usage"
          exit 0 ;;
    m  )  case "$OPTARG" in
            add    )  mode="+" ;;
            delete )  mode="-" ;;
            update )  mode="~" ;;
            *      )  printf "invalid mode: $OPTARG\n" >&2
                      exit 1 ;;
          esac ;;
    p  )  preview="true" ;;
    t  )  tags="${tags}${OPTARG}\n" ;;
    \? )  printf "$usage" | head -n 1 >&2
          exit 2 ;;
  esac
done
shift $(($OPTIND - 1))

if [ x"$GITGO_DEBUG" == x"true" ]
then set -x
fi

############################################################################

# what happens if two files have the same basename?
format_ls_tree() {
  attachments="$1";

  printf "%b" "$attachments" |
  while read file
  do
    if [ "$file" ]
    then
      name=`basename "$file"`
      sha=`git hash-object -w "$file"`
      printf "100644 blob %s\t%s\n" "$sha" "$name"
    fi
  done
}

format_metadata () {
  tags="$1"; mode="$2";
  shift 2;

  printf -- "\n---\n"

  printf "%b" "$tags" |
  while read tag
  do
    if [ "$tag" ]
    then printf ": %s\n" "$tag"
    fi
  done

  for parent in $@
  do
    if [ "$parent" ]
    then
      ref=`git rev-parse --verify -q "$parent"`
      if [ $? -eq 0 ] || [ $force ]
      then
        printf "%s %s\n" "$mode" "${ref:-$parent}"
      else
        printf "could not resolve ref: $parent\n" >&2
        exit 1
      fi
    fi
  done
}

############################################################################

parent=`git rev-parse --verify -q "$branch"`

set -e
metadata=`format_metadata "$tags" "$mode" $@`
tree=`format_ls_tree "$attachments" | git mktree`
sha=`cat - <( printf "%b" "$metadata" ) | git commit-tree "$tree" ${parent:+-p} $parent`

if [ "$preview" ]
then git log -n1 --format=raw "$sha"
else printf "%s\n" "$sha" | tee .git/refs/heads/"$branch"
fi