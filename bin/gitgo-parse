#!/bin/bash
############################################################################
# Routines to parse and process gitgo messages
# . gitgo-parse
############################################################################

# Produce a list of raw gitgo data between two refs a..b (as per git-log). The
# raw format is:
#
#   commit type value
#
# Where type is one of the gitgo types [+-~:].
raw_data () {
a=$1; b=$2;
git log --format=raw $a${b:+..}$b |
awk '
BEGIN           { n=0 }
/^commit /      { sha=$2; next }
/^    ---/      { n=1; next }
/^    [+-~:] /  { if ( n > 0 ) meta[n++] = $0; next }
/^$/            { print_meta(n, meta) }
                { n=0 }
END             { print_meta(n, meta) }

function print_meta(n, meta) {
  if ( n > 0 ) {
    for (i=n-1; i>0; i--) {
      sub("    ", "", meta[i])
      printf "%s %s\n", sha, meta[i]
    }
    printf "%s . %s\n", sha, sha
  }
}
'
}
