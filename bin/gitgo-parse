#!/bin/bash
############################################################################
# Routines to parse and process gitgo messages
# . gitgo-parse
############################################################################

# Produce a list of raw gitgo data between two refs a..b (as per git-log). The
# raw format is:
#
#   commit type value
#
# Where type is one of the gitgo types [+-~:].
raw_data () {
a=$1; b=$2;
git log --format=raw $a${b:+..}$b |
awk '
/^commit /      { n=0; sha=$2; }
/^    ---/      { n=1; }
/^    [+-~:] /  { store_meta() }
/^$/            { print_meta() }
END             { print_meta() }

function store_meta () {
  if ( n > 0 ) meta[n++] = $0
}
function print_meta() {
  if ( n > 0 ) {
    for (i=n-1; i>0; i--) {
      sub("    ", "", meta[i])
      printf "%s %s\n", sha, meta[i]
    }
    printf "%s . %s\n", sha, sha
  }
}
'
}
